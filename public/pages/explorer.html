<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="College Explorer - Path Pal">
  <title>College Explorer - Path Pal</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/css/style.css">
  <meta name="theme-color" content="#0d8c79">
</head>
<body>
  <div class="desktop-message">
    <h1><img src="/media/icons/Mobile256x256.png" alt="Mobile" style="width: 48px; height: 48px; vertical-align: middle; margin-right: 0.5rem;"> Mobile App Required</h1>
    <p>Path Pal is designed for mobile devices. Please open this site on your mobile phone or tablet.</p>
  </div>

  <header>
    <div class="header-content container">
      <div class="logo">
        <img src="/media/logo/logo64x64.png" alt="Path Pal Logo">
        <h1>Path Pal</h1>
      </div>
      <button class="menu-toggle" aria-label="Toggle menu"><img src="/media/icons/Hamburger128x128.png" alt="Menu" style="width: 24px; height: 24px;"></button>
    </div>
  </header>

  <nav>
    <ul>
      <li><a href="/index.html">Home</a></li>
      <li><a href="/profile.html">My Profile</a></li>
      <li><a href="/odds.html">Admissions Odds</a></li>
      <li><a href="/simulator.html">"What If" Simulator</a></li>
      <li><a href="/explorer.html" class="active">College Explorer</a></li>
      <li><a href="/career.html">Career & Salary Paths</a></li>
      <li><a href="/activities.html">Activity & Internship Recs</a></li>
      <li><a href="/planner.html">4-Year Planner</a></li>
      <li><a href="/messages.html">Messages</a></li>
      <li><a href="/saved.html">Saved Colleges</a></li>
    </ul>
  </nav>

  <main>
    <div class="container">
      <h2 style="color: var(--primary-green); margin: 1rem 0;">College Explorer</h2>

      <!-- Filters -->
      <div class="filters">
        <h3 style="color: var(--primary-green); margin-bottom: 1rem;">Filters</h3>
        <div class="filters-grid">
          <div class="form-group">
            <label>Chance of Getting In</label>
            <select id="filter-chance">
              <option value="">All</option>
              <option value="safety">Safety</option>
              <option value="target">Target</option>
              <option value="reach">Reach</option>
            </select>
          </div>
          <div class="form-group">
            <label>Region</label>
            <select id="filter-region">
              <option value="">All</option>
              <option value="California">California</option>
              <option value="Massachusetts">Massachusetts</option>
              <option value="Michigan">Michigan</option>
              <option value="Texas">Texas</option>
              <option value="Pennsylvania">Pennsylvania</option>
              <option value="Arizona">Arizona</option>
            </select>
          </div>
          <div class="form-group">
            <label>School Size</label>
            <select id="filter-size">
              <option value="">All</option>
              <option value="Small">Small</option>
              <option value="Medium">Medium</option>
              <option value="Large">Large</option>
            </select>
          </div>
          <div class="form-group">
            <label>School Type</label>
            <select id="filter-type">
              <option value="">All</option>
              <option value="Public">Public</option>
              <option value="Private">Private</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" onclick="filterColleges()" style="width: 100%; margin-top: 1rem;">
          Apply Filters
        </button>
        <button class="btn btn-secondary" onclick="resetFilters()" style="width: 100%; margin-top: 0.5rem;">
          Reset Filters
        </button>
      </div>

      <!-- AI Recommendations -->
      <div class="card">
        <h3>AI Recommendations</h3>
        <p>Based on your profile and preferences, here are colleges that fit you best.</p>
        <button class="btn btn-secondary" onclick="getAIRecommendations()" style="width: 100%; margin-top: 1rem;">
          Get Personalized Recommendations
        </button>
        <div id="ai-recommendations" style="margin-top: 1rem;"></div>
      </div>

      <!-- College List -->
      <div id="colleges-list">
        <h3 style="color: var(--primary-green); margin: 1rem 0;">All Colleges</h3>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 Path Pal. v1.05</p>
    </div>
  </footer>

  <script src="/js/api.js"></script>
  <script src="/js/app.js"></script>
  <script>
    let allColleges = [];
    let filteredColleges = [];

    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize user ID first
      await initializeUserId();
      
      allColleges = Colleges;
      filteredColleges = [...allColleges];
      await displayColleges(filteredColleges);
    });

    async function displayColleges(colleges) {
      const container = document.getElementById('colleges-list');
      const profile = await UserProfile.get();

      if (colleges.length === 0) {
        container.innerHTML = '<div class="card"><p>No colleges match your filters. Try adjusting your search criteria.</p></div>';
        return;
      }

      container.innerHTML = '<h3 style="color: var(--primary-green); margin: 1rem 0;">All Colleges</h3>';

      colleges.forEach(college => {
        const odds = calculateAdmissionOdds(profile, college);
        const category = categorizeSchool(odds);
        const isSaved = SavedColleges.isSaved(college.id);
        
        const card = document.createElement('div');
        card.className = 'card';
        card.style.marginBottom = '1rem';
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div style="flex: 1;">
              <h4 style="color: var(--primary-green); margin-bottom: 0.5rem;">${college.name}</h4>
              <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.25rem;"><img src="/media/icons/Location128x128.png" alt="Location" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 0.25rem;"> ${college.location}</p>
              <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 0.25rem;">${college.type} â€¢ ${college.size}</p>
              <p style="color: var(--text-light); font-size: 0.9rem;">Acceptance Rate: ${(college.acceptanceRate * 100).toFixed(1)}%</p>
            </div>
            <span class="badge badge-${category.category}">${category.label}</span>
          </div>
          <div style="background: var(--light-mint); padding: 1rem; border-radius: 8px; text-align: center; margin-bottom: 1rem;">
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary-green);">${odds.toFixed(0)}%</div>
            <div style="color: var(--text-light); font-size: 0.85rem;">Your Admission Odds</div>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="saveCollege(${college.id})" style="flex: 1; ${isSaved ? 'background: var(--success);' : ''}">
              ${isSaved ? '<img src="/media/icons/Check256x256.png" alt="Check" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 0.25rem;"> Saved' : '<img src="/media/icons/Star128x128.png" alt="Star" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 0.25rem;"> Save'}
            </button>
            <button class="btn btn-secondary" onclick="viewCollegeDetails(${college.id})" style="flex: 1;">
              View Details
            </button>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    async function filterColleges() {
      const chanceFilter = document.getElementById('filter-chance').value;
      const regionFilter = document.getElementById('filter-region').value;
      const sizeFilter = document.getElementById('filter-size').value;
      const typeFilter = document.getElementById('filter-type').value;
      const profile = await UserProfile.get();

      filteredColleges = allColleges.filter(college => {
        // Chance filter
        if (chanceFilter) {
          const odds = calculateAdmissionOdds(profile, college);
          const category = categorizeSchool(odds);
          if (category.category !== chanceFilter) return false;
        }

        // Region filter
        if (regionFilter && college.location !== regionFilter) return false;

        // Size filter
        if (sizeFilter && college.size !== sizeFilter) return false;

        // Type filter
        if (typeFilter && college.type !== typeFilter) return false;

        return true;
      });

      await displayColleges(filteredColleges);
    }

    async function resetFilters() {
      document.getElementById('filter-chance').value = '';
      document.getElementById('filter-region').value = '';
      document.getElementById('filter-size').value = '';
      document.getElementById('filter-type').value = '';
      filteredColleges = [...allColleges];
      await displayColleges(filteredColleges);
    }

    async function saveCollege(collegeId) {
      const college = allColleges.find(c => c.id === collegeId);
      if (!college) return;
      
      const isSaved = SavedColleges.isSaved(collegeId);
      
      if (isSaved) {
        SavedColleges.remove(collegeId);
        await displayColleges(filteredColleges);
        showNotification(`${college.name} removed from saved`, 'info');
      } else {
        SavedColleges.add(college);
        await displayColleges(filteredColleges);
        showNotification(`${college.name} saved!`, 'success');
      }
    }

    function viewCollegeDetails(collegeId) {
      const college = allColleges.find(c => c.id === collegeId);
      if (college) {
        alert(`${college.name}\n\nLocation: ${college.location}\nType: ${college.type}\nSize: ${college.size}\nAcceptance Rate: ${(college.acceptanceRate * 100).toFixed(1)}%\n\nClick "Save" to bookmark this college.`);
      }
    }

    async function getAIRecommendations() {
      const container = document.getElementById('ai-recommendations');
      container.innerHTML = '<p class="loading">Analyzing your profile...</p>';

      try {
        const profile = await UserProfile.get();
        const message = `Based on my profile (GPA: ${profile.gpa || 'not set'}, SAT: ${profile.sat || 'not set'}, ACT: ${profile.act || 'not set'}, Grade: ${profile.grade || 'not set'}, Majors: ${(profile.majors || []).join(', ') || 'not specified'}, Career Goals: ${profile.careerGoals || 'not specified'}), recommend 5 colleges that would be a good fit. Format as a numbered list with brief reasoning for each.`;
        
        const response = await sendChatMessage(message);
        const recommendations = response.message.split('\n').filter(line => line.trim());
        
        container.innerHTML = '<div style="background: var(--white); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);">' +
          '<h4 style="color: var(--primary-green); margin-bottom: 1rem;">Personalized Recommendations</h4>' +
          '<ol style="padding-left: 1.5rem;">' +
          recommendations.map(rec => `<li style="margin-bottom: 0.75rem; line-height: 1.6;">${rec.trim().replace(/^\d+\.\s*/, '')}</li>`).join('') +
          '</ol>' +
          '</div>';
      } catch (error) {
        container.innerHTML = '<p style="color: var(--text-light);">Unable to load recommendations at this time. Please try again later.</p>';
      }
    }
  </script>
</body>
</html>

